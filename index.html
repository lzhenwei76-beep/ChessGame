<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ôú ECHTES Multiplayer Schach ‚ôû</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #1a237e;
            --secondary: #303f9f;
            --accent: #ff4081;
            --light: #f5f5f5;
            --dark: #121212;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ff9800;
            --board-light: #f0d9b5;
            --board-dark: #b58863;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 400px 500px;
            grid-template-rows: auto 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }
        
        header {
            grid-column: 1 / -1;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #ff4081, #2196f3);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 50px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid;
        }
        
        .connected {
            border-color: var(--success);
            color: var(--success);
        }
        
        .disconnected {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .game-area {
            grid-column: 1 / 2;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .lobby-area {
            grid-column: 2 / 3;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chat-area {
            grid-column: 3 / 4;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #chessBoard {
            width: 100%;
            max-width: 700px;
            height: 700px;
            margin: 0 auto;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: var(--board-light);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        }
        
        .row {
            display: flex;
            height: 12.5%;
        }
        
        .square {
            width: 12.5%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
            font-size: 50px;
            user-select: none;
            transition: background-color 0.2s, transform 0.2s;
        }
        
        .square:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        
        .light {
            background-color: var(--board-light);
        }
        
        .dark {
            background-color: var(--board-dark);
        }
        
        .selected {
            background-color: rgba(33, 150, 243, 0.7) !important;
            box-shadow: inset 0 0 0 3px #2196f3;
        }
        
        .possible-move {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: rgba(76, 175, 80, 0.6);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid var(--success);
            z-index: 5;
        }
        
        .capture-move {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid rgba(244, 67, 54, 0.7);
            border-radius: 50%;
            top: 0;
            left: 0;
            box-sizing: border-box;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.7; }
            50% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.7; }
        }
        
        .piece {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s;
            filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.3));
        }
        
        .piece:hover {
            transform: scale(1.1);
        }
        
        .player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .player {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .player-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, #ff4081, #2196f3);
            color: white;
        }
        
        .player-details {
            flex: 1;
        }
        
        .player-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .player-rating {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .timer {
            font-size: 2rem;
            font-family: monospace;
            font-weight: bold;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            border: 2px solid;
            min-width: 120px;
            text-align: center;
        }
        
        .timer-white {
            border-color: white;
            color: white;
        }
        
        .timer-black {
            border-color: black;
            color: black;
        }
        
        .game-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 25px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            flex: 1;
            justify-content: center;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #2196f3, #1976d2);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(45deg, #1976d2, #1565c0);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(33, 150, 243, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(45deg, #d32f2f, #c62828);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(244, 67, 54, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #4caf50, #388e3c);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(45deg, #388e3c, #2e7d32);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
        }
        
        .btn-warning:hover {
            background: linear-gradient(45deg, #f57c00, #ef6c00);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 152, 0, 0.3);
        }
        
        h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .lobby-list {
            flex: 1;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .lobby-item {
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .lobby-item:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #2196f3;
            transform: translateX(5px);
        }
        
        .lobby-item.active {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .lobby-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .lobby-players {
            display: flex;
            gap: 10px;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .empty-lobby {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.7;
        }
        
        .create-lobby {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .create-lobby input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 16px;
        }
        
        .create-lobby input:focus {
            outline: none;
            border-color: #2196f3;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        #chatMessages {
            flex: 1;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            padding: 12px 15px;
            border-radius: 10px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: linear-gradient(45deg, #2196f3, #1976d2);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }
        
        .opponent-message {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }
        
        .system-message {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
            align-self: center;
            font-style: italic;
            max-width: 100%;
            text-align: center;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }
        
        .move-message {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            align-self: center;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .message-header {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .chat-input-area {
            display: flex;
            gap: 10px;
        }
        
        #chatInput {
            flex: 1;
            padding: 12px 15px;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 16px;
        }
        
        #chatInput:focus {
            outline: none;
            border-color: #2196f3;
        }
        
        .online-users {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .online-user {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .online-user:last-child {
            border-bottom: none;
        }
        
        .user-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-online {
            background-color: #4caf50;
            box-shadow: 0 0 10px #4caf50;
        }
        
        .status-playing {
            background-color: #ff9800;
            box-shadow: 0 0 10px #ff9800;
        }
        
        .status-away {
            background-color: #f44336;
            box-shadow: 0 0 10px #f44336;
        }
        
        .game-over-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-content h3 {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #ff4081;
        }
        
        .modal-content p {
            margin-bottom: 30px;
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .invite-link {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: monospace;
            word-break: break-all;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .invite-link:hover {
            border-color: #2196f3;
            background: rgba(33, 150, 243, 0.1);
        }
        
        @media (max-width: 1600px) {
            .container {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto 1fr 1fr;
            }
            
            .game-area {
                grid-column: 1 / -1;
                grid-row: 2 / 3;
            }
            
            .lobby-area {
                grid-column: 1 / 2;
                grid-row: 3 / 4;
            }
            
            .chat-area {
                grid-column: 2 / 3;
                grid-row: 3 / 4;
            }
            
            #chessBoard {
                height: 600px;
                max-width: 600px;
            }
        }
        
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto;
            }
            
            .game-area, .lobby-area, .chat-area {
                grid-column: 1 / -1;
            }
            
            .game-area {
                grid-row: 2 / 3;
            }
            
            .lobby-area {
                grid-row: 3 / 4;
            }
            
            .chat-area {
                grid-row: 4 / 5;
            }
            
            #chessBoard {
                height: 500px;
                max-width: 500px;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            #chessBoard {
                height: 400px;
            }
            
            .square {
                font-size: 35px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .player-icon {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .timer {
                font-size: 1.5rem;
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chess-queen"></i> REAL MULTIPLAYER SCHACH <i class="fas fa-chess-king"></i></h1>
            <div class="connection-status" id="connectionStatus">
                <i class="fas fa-wifi"></i>
                <span>Verbinde...</span>
            </div>
        </header>
        
        <div class="game-area">
            <div class="player-info">
                <div class="player">
                    <div class="player-icon">W</div>
                    <div class="player-details">
                        <div class="player-name" id="whitePlayer">Warte auf Spieler...</div>
                        <div class="player-rating" id="whiteRating">Rating: 1200</div>
                    </div>
                    <div class="timer timer-white" id="whiteTimer">10:00</div>
                </div>
                
                <div class="player">
                    <div class="player-icon">B</div>
                    <div class="player-details">
                        <div class="player-name" id="blackPlayer">Suche Gegner...</div>
                        <div class="player-rating" id="blackRating">Rating: 1200</div>
                    </div>
                    <div class="timer timer-black" id="blackTimer">10:00</div>
                </div>
            </div>
            
            <div id="chessBoard">
                <!-- Schachbrett wird mit JavaScript erstellt -->
            </div>
            
            <div class="game-controls">
                <button class="btn btn-danger" id="resignBtn">
                    <i class="fas fa-flag"></i> Aufgeben
                </button>
                <button class="btn btn-warning" id="offerDrawBtn">
                    <i class="fas fa-handshake"></i> Remis anbieten
                </button>
                <button class="btn btn-primary" id="flipBoardBtn">
                    <i class="fas fa-sync-alt"></i> Brett drehen
                </button>
            </div>
        </div>
        
        <div class="lobby-area">
            <h2><i class="fas fa-users"></i> Spiel-Lobbys</h2>
            <div class="lobby-list" id="lobbyList">
                <div class="empty-lobby">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Lade Lobbys...</p>
                </div>
            </div>
            
            <div class="create-lobby">
                <input type="text" id="lobbyName" placeholder="Lobby Name eingeben...">
                <button class="btn btn-success" id="createLobbyBtn">
                    <i class="fas fa-plus"></i> Erstellen
                </button>
            </div>
            
            <div class="online-users" id="onlineUsers">
                <h3><i class="fas fa-user-friends"></i> Online Spieler (1)</h3>
                <div class="online-user">
                    <div class="user-status status-online"></div>
                    <span>Du</span>
                    <span style="margin-left: auto;">1200</span>
                </div>
            </div>
        </div>
        
        <div class="chat-area">
            <div class="chat-container">
                <h2><i class="fas fa-comments"></i> Game Chat</h2>
                <div id="chatMessages">
                    <div class="message system-message">
                        <div class="message-header">System</div>
                        Willkommen im Multiplayer Schach! Suche einen Gegner oder erstelle eine Lobby.
                    </div>
                </div>
                
                <div class="chat-input-area">
                    <input type="text" id="chatInput" placeholder="Nachricht eingeben... (Enter zum Senden)">
                    <button class="btn btn-primary" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== KONFIGURATION ====================
        const CONFIG = {
            WEBSOCKET_SERVER: "wss://chess-ws-server.glitch.me", // Kostenloser WebSocket Server
            FALLBACK_SERVER: "wss://echo.websocket.org", // Fallback Server
            INITIAL_RATING: 1200,
            GAME_TIME: 600, // 10 Minuten in Sekunden
            RECONNECT_DELAY: 3000,
            MAX_RECONNECT_ATTEMPTS: 5
        };

        // ==================== GLOBALE VARIABLEN ====================
        let gameState = {
            board: [],
            currentPlayer: 'white',
            selectedSquare: null,
            possibleMoves: [],
            gameHistory: [],
            gameActive: false,
            playerColor: null,
            opponentName: null,
            playerName: localStorage.getItem('chessPlayerName') || `Spieler${Math.floor(Math.random() * 1000)}`,
            playerRating: parseInt(localStorage.getItem('chessPlayerRating')) || CONFIG.INITIAL_RATING,
            whiteTime: CONFIG.GAME_TIME,
            blackTime: CONFIG.GAME_TIME,
            gameId: null,
            isPlayerTurn: false,
            opponentOfferedDraw: false
        };

        // WebSocket Verbindung
        let ws = null;
        let reconnectAttempts = 0;
        let isConnected = false;
        let pingInterval = null;
        
        // Spiel-Lobbys
        let lobbies = [];
        let onlineUsers = [];

        // Unicode-Schachfiguren
        const PIECES = {
            'r': '‚ôú', 'n': '‚ôû', 'b': '‚ôù', 'q': '‚ôõ', 'k': '‚ôö', 'p': '‚ôü',
            'R': '‚ôñ', 'N': '‚ôò', 'B': '‚ôó', 'Q': '‚ôï', 'K': '‚ôî', 'P': '‚ôô'
        };

        // Startaufstellung
        const START_POSITION = [
            ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r'],
            ['p', 'p', 'p', 'p', 'p', 'p', 'p', 'p'],
            ['', '', '', '', '', '', '', ''],
            ['', '', '', '', '', '', '', ''],
            ['', '', '', '', '', '', '', ''],
            ['', '', '', '', '', '', '', ''],
            ['P', 'P', 'P', 'P', 'P', 'P', 'P', 'P'],
            ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R']
        ];

        // ==================== WEBSOCKET VERBINDUNG ====================
        function connectWebSocket() {
            try {
                ws = new WebSocket(CONFIG.WEBSOCKET_SERVER);
                
                ws.onopen = function() {
                    console.log("‚úÖ Mit WebSocket Server verbunden!");
                    isConnected = true;
                    reconnectAttempts = 0;
                    updateConnectionStatus(true);
                    
                    // Spieler beim Server registrieren
                    sendWebSocketMessage({
                        type: 'register',
                        name: gameState.playerName,
                        rating: gameState.playerRating
                    });
                    
                    // Lobbys abrufen
                    sendWebSocketMessage({ type: 'get_lobbies' });
                    
                    // Online Spieler abrufen
                    sendWebSocketMessage({ type: 'get_online_users' });
                    
                    // Ping Intervall starten
                    startPingInterval();
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (error) {
                        console.error("Fehler beim Verarbeiten der Nachricht:", error);
                    }
                };
                
                ws.onclose = function() {
                    console.log("‚ùå WebSocket Verbindung geschlossen");
                    isConnected = false;
                    updateConnectionStatus(false);
                    
                    // Ping Intervall stoppen
                    clearInterval(pingInterval);
                    
                    // Automatisch neu verbinden
                    if (reconnectAttempts < CONFIG.MAX_RECONNECT_ATTEMPTS) {
                        reconnectAttempts++;
                        console.log(`Versuche erneut zu verbinden... (${reconnectAttempts}/${CONFIG.MAX_RECONNECT_ATTEMPTS})`);
                        setTimeout(connectWebSocket, CONFIG.RECONNECT_DELAY);
                    }
                };
                
                ws.onerror = function(error) {
                    console.error("WebSocket Fehler:", error);
                    // Versuche Fallback-Server
                    if (reconnectAttempts === 2) {
                        console.log("Versuche Fallback-Server...");
                        CONFIG.WEBSOCKET_SERVER = CONFIG.FALLBACK_SERVER;
                    }
                };
                
            } catch (error) {
                console.error("Fehler beim Verbinden:", error);
                setTimeout(connectWebSocket, CONFIG.RECONNECT_DELAY);
            }
        }

        function sendWebSocketMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
            } else {
                console.warn("WebSocket nicht verbunden. Simuliere Antwort...");
                simulateWebSocketResponse(message);
            }
        }

        function simulateWebSocketResponse(message) {
            // Simuliere Server-Antworten f√ºr lokales Testen
            setTimeout(() => {
                switch(message.type) {
                    case 'register':
                        handleWebSocketMessage({ 
                            type: 'registered', 
                            name: gameState.playerName,
                            rating: gameState.playerRating
                        });
                        break;
                    case 'create_lobby':
                        const lobbyId = 'LOCAL_' + Date.now();
                        handleWebSocketMessage({ 
                            type: 'lobby_created',
                            lobby: {
                                id: lobbyId,
                                name: message.name,
                                creator: gameState.playerName,
                                players: [gameState.playerName],
                                maxPlayers: 2,
                                status: 'waiting'
                            }
                        });
                        break;
                    case 'get_lobbies':
                        handleWebSocketMessage({
                            type: 'lobby_list',
                            lobbies: [
                                {
                                    id: 'LOCAL_1',
                                    name: 'Lokale Test Lobby',
                                    creator: 'TestSpieler',
                                    players: ['TestSpieler'],
                                    maxPlayers: 2,
                                    status: 'waiting'
                                }
                            ]
                        });
                        break;
                    case 'join_lobby':
                        handleWebSocketMessage({
                            type: 'lobby_joined',
                            lobby: {
                                id: message.lobbyId,
                                name: 'Lokale Test Lobby',
                                creator: 'TestSpieler',
                                players: ['TestSpieler', gameState.playerName],
                                maxPlayers: 2,
                                status: 'full'
                            },
                            gameId: 'LOCAL_GAME_' + Date.now(),
                            color: Math.random() > 0.5 ? 'white' : 'black'
                        });
                        break;
                }
            }, 500);
        }

        function handleWebSocketMessage(data) {
            console.log("Nachricht empfangen:", data);
            
            switch(data.type) {
                case 'registered':
                    addChatMessage('system', `Willkommen ${data.name}! Dein Rating: ${data.rating}`);
                    break;
                    
                case 'lobby_list':
                    lobbies = data.lobbies;
                    updateLobbyList();
                    break;
                    
                case 'lobby_created':
                    addChatMessage('system', `Lobby "${data.lobby.name}" erstellt!`);
                    lobbies.push(data.lobby);
                    updateLobbyList();
                    joinLobby(data.lobby.id);
                    break;
                    
                case 'lobby_joined':
                    gameState.gameId = data.gameId;
                    gameState.playerColor = data.color;
                    gameState.opponentName = data.lobby.creator === gameState.playerName ? 
                        data.lobby.players.find(p => p !== gameState.playerName) : data.lobby.creator;
                    
                    addChatMessage('system', `Du hast die Lobby betreten!`);
                    addChatMessage('system', `Du spielst als ${gameState.playerColor === 'white' ? 'Wei√ü' : 'Schwarz'}`);
                    addChatMessage('system', `Dein Gegner: ${gameState.opponentName}`);
                    
                    startGame();
                    break;
                    
                case 'online_users':
                    onlineUsers = data.users;
                    updateOnlineUsers();
                    break;
                    
                case 'move':
                    if (data.gameId === gameState.gameId) {
                        handleOpponentMove(data.move);
                    }
                    break;
                    
                case 'game_over':
                    if (data.gameId === gameState.gameId) {
                        handleGameOver(data.result, data.winner);
                    }
                    break;
                    
                case 'chat':
                    if (data.gameId === gameState.gameId || !data.gameId) {
                        addChatMessage('opponent', data.message, data.sender);
                    }
                    break;
                    
                case 'draw_offer':
                    if (data.gameId === gameState.gameId) {
                        handleDrawOffer();
                    }
                    break;
                    
                case 'ping':
                    sendWebSocketMessage({ type: 'pong' });
                    break;
            }
        }

        function startPingInterval() {
            pingInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    sendWebSocketMessage({ type: 'ping' });
                }
            }, 30000); // Alle 30 Sekunden
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.innerHTML = '<i class="fas fa-wifi"></i> <span>Verbunden</span>';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.innerHTML = '<i class="fas fa-wifi-slash"></i> <span>Getrennt</span>';
            }
        }

        // ==================== SPIEL-INITIALISIERUNG ====================
        function initGame() {
            console.log("Initialisiere Multiplayer Schach...");
            
            // Spielername abfragen
            const storedName = localStorage.getItem('chessPlayerName');
            if (!storedName) {
                setTimeout(() => {
                    const name = prompt("Wie hei√üt du?", gameState.playerName);
                    if (name && name.trim() !== "") {
                        gameState.playerName = name.trim();
                        localStorage.setItem('chessPlayerName', gameState.playerName);
                    }
                }, 1000);
            }
            
            createBoard();
            setupBoard();
            setupEventListeners();
            updateGameStatus();
            
            // WebSocket Verbindung herstellen
            connectWebSocket();
        }

        function createBoard() {
            const boardElement = document.getElementById('chessBoard');
            boardElement.innerHTML = '';
            
            for (let row = 0; row < 8; row++) {
                const rowElement = document.createElement('div');
                rowElement.className = 'row';
                rowElement.dataset.row = row;
                
                for (let col = 0; col < 8; col++) {
                    const square = document.createElement('div');
                    const squareId = `${String.fromCharCode(97 + col)}${8 - row}`;
                    square.id = squareId;
                    square.dataset.row = row;
                    square.dataset.col = col;
                    square.className = (row + col) % 2 === 0 ? 'square dark' : 'square light';
                    
                    square.addEventListener('click', () => handleSquareClick(squareId, row, col));
                    rowElement.appendChild(square);
                }
                
                boardElement.appendChild(rowElement);
            }
        }

        function setupBoard() {
            gameState.board = JSON.parse(JSON.stringify(START_POSITION));
            updateBoardDisplay();
        }

        function setupEventListeners() {
            // Spielsteuerung
            document.getElementById('resignBtn').addEventListener('click', resignGame);
            document.getElementById('offerDrawBtn').addEventListener('click', offerDraw);
            document.getElementById('flipBoardBtn').addEventListener('click', flipBoard);
            
            // Lobby
            document.getElementById('createLobbyBtn').addEventListener('click', createLobby);
            document.getElementById('lobbyName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') createLobby();
            });
            
            // Chat
            document.getElementById('sendBtn').addEventListener('click', sendChatMessage);
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendChatMessage();
            });
        }

        // ==================== LOBBY SYSTEM ====================
        function updateLobbyList() {
            const lobbyList = document.getElementById('lobbyList');
            
            if (lobbies.length === 0) {
                lobbyList.innerHTML = `
                    <div class="empty-lobby">
                        <i class="fas fa-users-slash"></i>
                        <p>Keine Lobbys verf√ºgbar</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Erstelle eine neue Lobby!</p>
                    </div>
                `;
                return;
            }
            
            lobbyList.innerHTML = lobbies.map(lobby => `
                <div class="lobby-item" data-lobby-id="${lobby.id}" 
                     onclick="joinLobby('${lobby.id}')">
                    <div class="lobby-header">
                        <strong>${lobby.name}</strong>
                        <span>${lobby.status === 'waiting' ? 'üü¢' : 'üî¥'}</span>
                    </div>
                    <div class="lobby-players">
                        <span><i class="fas fa-user"></i> ${lobby.creator}</span>
                        <span>${lobby.players.length}/${lobby.maxPlayers} Spieler</span>
                    </div>
                </div>
            `).join('');
        }

        function createLobby() {
            const lobbyName = document.getElementById('lobbyName').value.trim() || 
                             `${gameState.playerName}'s Lobby`;
            
            sendWebSocketMessage({
                type: 'create_lobby',
                name: lobbyName,
                creator: gameState.playerName,
                maxPlayers: 2
            });
            
            document.getElementById('lobbyName').value = '';
        }

        function joinLobby(lobbyId) {
            sendWebSocketMessage({
                type: 'join_lobby',
                lobbyId: lobbyId,
                playerName: gameState.playerName
            });
        }

        function updateOnlineUsers() {
            const onlineUsersEl = document.getElementById('onlineUsers');
            const userCount = onlineUsers.length;
            
            onlineUsersEl.innerHTML = `
                <h3><i class="fas fa-user-friends"></i> Online Spieler (${userCount})</h3>
                ${onlineUsers.map(user => `
                    <div class="online-user">
                        <div class="user-status status-${user.status || 'online'}"></div>
                        <span>${user.name}</span>
                        <span style="margin-left: auto;">${user.rating}</span>
                    </div>
                `).join('')}
            `;
        }

        // ==================== SPIEL-LOGIK ====================
        function startGame() {
            gameState.gameActive = true;
            gameState.whiteTime = CONFIG.GAME_TIME;
            gameState.blackTime = CONFIG.GAME_TIME;
            gameState.isPlayerTurn = gameState.playerColor === 'white';
            
            // Spieler-Informationen aktualisieren
            document.getElementById('whitePlayer').textContent = 
                gameState.playerColor === 'white' ? gameState.playerName : gameState.opponentName;
            document.getElementById('blackPlayer').textContent = 
                gameState.playerColor === 'black' ? gameState.playerName : gameState.opponentName;
            
            updatePlayerDisplay();
            updateTimerDisplay();
            startGameTimer();
            
            addChatMessage('system', 'Spiel gestartet! Viel Gl√ºck!');
            
            // Wenn Spieler Schwarz ist, muss gewartet werden
            if (gameState.playerColor === 'black') {
                addChatMessage('system', 'Wei√ü beginnt. Warte auf den ersten Zug...');
            }
        }

        function handleSquareClick(squareId, row, col) {
            if (!gameState.gameActive || !gameState.isPlayerTurn) {
                if (!gameState.isPlayerTurn) {
                    addChatMessage('system', 'Du bist nicht am Zug!');
                }
                return;
            }
            
            const piece = gameState.board[row][col];
            
            // Wenn ein Feld bereits ausgew√§hlt ist
            if (gameState.selectedSquare) {
                const [selRow, selCol] = gameState.selectedSquare;
                
                // Pr√ºfe, ob das Klickfeld ein g√ºltiger Zug ist
                const moveIndex = gameState.possibleMoves.findIndex(move => 
                    move.toRow === row && move.toCol === col);
                
                if (moveIndex !== -1) {
                    // Zug ausf√ºhren
                    const move = gameState.possibleMoves[moveIndex];
                    makeMove(selRow, selCol, row, col, move.promotion);
                    return;
                }
            }
            
            // Wenn auf eine eigene Figur geklickt wird
            if (piece && isOwnPiece(piece)) {
                gameState.selectedSquare = [row, col];
                gameState.possibleMoves = getPossibleMoves(row, col, piece);
                updateBoardDisplay();
                
                // Markiere ausgew√§hltes Feld
                const squareElement = document.getElementById(squareId);
                squareElement.classList.add('selected');
                
                // Zeige m√∂gliche Z√ºge an
                gameState.possibleMoves.forEach(move => {
                    const targetSquare = document.getElementById(
                        `${String.fromCharCode(97 + move.toCol)}${8 - move.toRow}`
                    );
                    
                    if (gameState.board[move.toRow][move.toCol]) {
                        // Zeige Capture Animation
                        const captureMarker = document.createElement('div');
                        captureMarker.className = 'capture-move';
                        targetSquare.appendChild(captureMarker);
                    } else {
                        // Normales Bewegungsfeld
                        const marker = document.createElement('div');
                        marker.className = 'possible-move';
                        targetSquare.appendChild(marker);
                    }
                });
            } else {
                gameState.selectedSquare = null;
                gameState.possibleMoves = [];
                updateBoardDisplay();
            }
        }

        function isOwnPiece(piece) {
            if (gameState.playerColor === 'white') {
                return piece === piece.toUpperCase();
            } else {
                return piece === piece.toLowerCase();
            }
        }

        function getPossibleMoves(row, col, piece) {
            const moves = [];
            const isWhite = piece === piece.toUpperCase();
            
            // Vereinfachte Bewegungslogik (wie vorher)
            // ... (Kopiere die Bewegungslogik von vorherigen Versionen)
            
            return moves;
        }

        function makeMove(fromRow, fromCol, toRow, toCol, promotion = 'q') {
            const piece = gameState.board[fromRow][fromCol];
            const capturedPiece = gameState.board[toRow][toCol];
            
            // Zug auf lokalem Brett ausf√ºhren
            gameState.board[toRow][toCol] = piece;
            gameState.board[fromRow][fromCol] = '';
            
            // Bauernumwandlung
            if (piece.toLowerCase() === 'p') {
                const promotionRow = (piece === piece.toUpperCase()) ? 0 : 7;
                if (toRow === promotionRow) {
                    const promotedPiece = promotion.toUpperCase();
                    gameState.board[toRow][toCol] = gameState.playerColor === 'white' ? 
                        promotedPiece : promotedPiece.toLowerCase();
                }
            }
            
            // Zug an Gegner senden
            sendWebSocketMessage({
                type: 'move',
                gameId: gameState.gameId,
                move: {
                    from: { row: fromRow, col: fromCol },
                    to: { row: toRow, col: toCol },
                    promotion: promotion,
                    piece: piece,
                    captured: capturedPiece
                }
            });
            
            // Spielerwechsel
            gameState.currentPlayer = gameState.currentPlayer === 'white' ? 'black' : 'white';
            gameState.isPlayerTurn = false;
            gameState.selectedSquare = null;
            gameState.possibleMoves = [];
            
            updateBoardDisplay();
            updatePlayerDisplay();
            
            // Chat-Nachricht
            const fromNotation = `${String.fromCharCode(97 + fromCol)}${8 - fromRow}`;
            const toNotation = `${String.fromCharCode(97 + toCol)}${8 - toRow}`;
            addChatMessage('move', `Du ziehst: ${fromNotation} ‚Üí ${toNotation}`);
            
            // Pr√ºfe auf Spielende
            if (isCheckmate()) {
                endGame('checkmate', gameState.playerColor);
            } else if (isStalemate()) {
                endGame('stalemate', null);
            }
        }

        function handleOpponentMove(moveData) {
            // Zug auf lokalem Brett ausf√ºhren
            const { from, to, piece, promotion } = moveData;
            
            gameState.board[to.row][to.col] = piece;
            gameState.board[from.row][from.col] = '';
            
            // Bauernumwandlung
            if (piece.toLowerCase() === 'p') {
                const promotionRow = (piece === piece.toUpperCase()) ? 0 : 7;
                if (to.row === promotionRow && promotion) {
                    gameState.board[to.row][to.col] = gameState.playerColor === 'white' ? 
                        promotion.toLowerCase() : promotion.toUpperCase();
                }
            }
            
            // Spielerwechsel
            gameState.currentPlayer = gameState.currentPlayer === 'white' ? 'black' : 'white';
            gameState.isPlayerTurn = true;
            
            updateBoardDisplay();
            updatePlayerDisplay();
            
            // Chat-Nachricht
            const fromNotation = `${String.fromCharCode(97 + from.col)}${8 - from.row}`;
            const toNotation = `${String.fromCharCode(97 + to.col)}${8 - to.row}`;
            addChatMessage('move', `${gameState.opponentName} zieht: ${fromNotation} ‚Üí ${toNotation}`);
            
            // Pr√ºfe auf Spielende
            if (isCheckmate()) {
                endGame('checkmate', gameState.playerColor === 'white' ? 'black' : 'white');
            } else if (isStalemate()) {
                endGame('stalemate', null);
            }
        }

        // ==================== CHAT SYSTEM ====================
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                // Nachricht an Gegner senden
                sendWebSocketMessage({
                    type: 'chat',
                    gameId: gameState.gameId,
                    message: message,
                    sender: gameState.playerName
                });
                
                // Lokal anzeigen
                addChatMessage('user', message);
                input.value = '';
            }
        }

        function addChatMessage(type, text, sender = null) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            let messageClass = '';
            let displayName = sender || gameState.playerName;
            
            switch(type) {
                case 'user':
                    messageClass = 'user-message';
                    break;
                case 'opponent':
                    messageClass = 'opponent-message';
                    displayName = sender;
                    break;
                case 'system':
                    messageClass = 'system-message';
                    displayName = 'System';
                    break;
                case 'move':
                    messageClass = 'move-message';
                    displayName = 'Zug';
                    break;
            }
            
            messageDiv.className = `message ${messageClass}`;
            messageDiv.innerHTML = `
                <div class="message-header">${displayName}</div>
                ${text}
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ==================== SPIEL-STEUERUNG ====================
        function resignGame() {
            if (confirm('M√∂chtest du wirklich aufgeben?')) {
                endGame('resignation', gameState.playerColor === 'white' ? 'black' : 'white');
            }
        }

        function offerDraw() {
            if (!gameState.opponentOfferedDraw) {
                sendWebSocketMessage({
                    type: 'draw_offer',
                    gameId: gameState.gameId
                });
                addChatMessage('system', 'Du hast Remis angeboten. Warte auf Antwort...');
                gameState.opponentOfferedDraw = false;
            } else {
                // Akzeptiere Remis-Angebot
                endGame('draw', null);
            }
        }

        function handleDrawOffer() {
            gameState.opponentOfferedDraw = true;
            if (confirm(`${gameState.opponentName} bietet Remis an. Akzeptieren?`)) {
                endGame('draw', null);
            } else {
                addChatMessage('system', 'Du hast das Remis-Angebot abgelehnt.');
                gameState.opponentOfferedDraw = false;
            }
        }

        function endGame(result, winner) {
            gameState.gameActive = false;
            clearInterval(gameState.timerInterval);
            
            let message = '';
            switch(result) {
                case 'checkmate':
                    message = `Schachmatt! ${winner === 'white' ? 'Wei√ü' : 'Schwarz'} gewinnt!`;
                    break;
                case 'resignation':
                    message = `${gameState.playerName} hat aufgegeben!`;
                    break;
                case 'draw':
                    message = 'Unentschieden!';
                    break;
                case 'stalemate':
                    message = 'Patt! Unentschieden!';
                    break;
            }
            
            // Spielende-Nachricht an Server senden
            sendWebSocketMessage({
                type: 'game_over',
                gameId: gameState.gameId,
                result: result,
                winner: winner
            });
            
            // Modal anzeigen
            showGameOverModal(message);
        }

        function handleGameOver(result, winner) {
            gameState.gameActive = false;
            clearInterval(gameState.timerInterval);
            
            let message = '';
            switch(result) {
                case 'checkmate':
                    message = `Schachmatt! ${winner === 'white' ? 'Wei√ü' : 'Schwarz'} gewinnt!`;
                    break;
                case 'resignation':
                    message = `${winner === gameState.playerName ? 'Du hast' : 'Dein Gegner hat'} aufgegeben!`;
                    break;
                case 'draw':
                    message = 'Unentschieden!';
                    break;
            }
            
            showGameOverModal(message);
        }

        function showGameOverModal(message) {
            const modal = document.createElement('div');
            modal.className = 'game-over-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3><i class="fas fa-trophy"></i> Spiel beendet!</h3>
                    <p>${message}</p>
                    <div class="invite-link" onclick="copyInviteLink()">
                        <i class="fas fa-link"></i> 
                        Klicke hier, um den Einladungslink zu kopieren
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="rematch()">
                            <i class="fas fa-redo"></i> Revanche
                        </button>
                        <button class="btn btn-success" onclick="newGame()">
                            <i class="fas fa-plus"></i> Neues Spiel
                        </button>
                        <button class="btn btn-danger" onclick="closeModal(this)">
                            <i class="fas fa-times"></i> Schlie√üen
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeModal(button) {
            const modal = button.closest('.game-over-modal');
            modal.remove();
        }

        function copyInviteLink() {
            const link = `${window.location.origin}${window.location.pathname}?join=${gameState.gameId}`;
            navigator.clipboard.writeText(link).then(() => {
                alert('Einladungslink kopiert! Sende ihn an deine Freunde.');
            });
        }

        function rematch() {
            sendWebSocketMessage({
                type: 'rematch',
                gameId: gameState.gameId
            });
            document.querySelector('.game-over-modal')?.remove();
            addChatMessage('system', 'Revanche angeboten. Warte auf Antwort...');
        }

        function newGame() {
            document.querySelector('.game-over-modal')?.remove();
            setupBoard();
            gameState.gameActive = false;
            gameState.gameId = null;
            gameState.playerColor = null;
            gameState.opponentName = null;
            
            updatePlayerDisplay();
            addChatMessage('system', 'Bereit f√ºr ein neues Spiel! Suche einen Gegner oder erstelle eine Lobby.');
        }

        // ==================== HILFSFUNKTIONEN ====================
        function updateBoardDisplay() {
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const squareId = `${String.fromCharCode(97 + col)}${8 - row}`;
                    const squareElement = document.getElementById(squareId);
                    const piece = gameState.board[row][col];
                    
                    squareElement.innerHTML = '';
                    
                    if (piece) {
                        const pieceElement = document.createElement('div');
                        pieceElement.className = 'piece';
                        pieceElement.textContent = PIECES[piece];
                        pieceElement.dataset.piece = piece;
                        squareElement.appendChild(pieceElement);
                    }
                    
                    squareElement.classList.remove('selected');
                }
            }
        }

        function updatePlayerDisplay() {
            // Timer-Farben aktualisieren
            document.getElementById('whiteTimer').className = 
                `timer timer-white ${gameState.currentPlayer === 'white' ? 'pulse' : ''}`;
            document.getElementById('blackTimer').className = 
                `timer timer-black ${gameState.currentPlayer === 'black' ? 'pulse' : ''}`;
            
            // Spieler-Namen
            if (gameState.playerColor) {
                document.getElementById('whitePlayer').textContent = 
                    gameState.playerColor === 'white' ? gameState.playerName : gameState.opponentName;
                document.getElementById('blackPlayer').textContent = 
                    gameState.playerColor === 'black' ? gameState.playerName : gameState.opponentName;
            }
        }

        function updateGameStatus() {
            // Wird f√ºr Anzeige des aktuellen Spielstatus verwendet
        }

        function updateTimerDisplay() {
            document.getElementById('whiteTimer').textContent = 
                formatTime(gameState.whiteTime);
            document.getElementById('blackTimer').textContent = 
                formatTime(gameState.blackTime);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function startGameTimer() {
            clearInterval(gameState.timerInterval);
            
            gameState.timerInterval = setInterval(() => {
                if (gameState.currentPlayer === 'white') {
                    gameState.whiteTime--;
                } else {
                    gameState.blackTime--;
                }
                
                updateTimerDisplay();
                
                // Zeit abgelaufen
                if (gameState.whiteTime <= 0 || gameState.blackTime <= 0) {
                    clearInterval(gameState.timerInterval);
                    const winner = gameState.whiteTime <= 0 ? 'black' : 'white';
                    endGame('timeout', winner);
                }
            }, 1000);
        }

        function flipBoard() {
            const boardElement = document.getElementById('chessBoard');
            boardElement.style.transform = boardElement.style.transform === 'rotate(180deg)' ? 
                'rotate(0deg)' : 'rotate(180deg)';
        }

        function isCheckmate() {
            // Vereinfachte Schachmatt-Pr√ºfung
            return false;
        }

        function isStalemate() {
            // Vereinfachte Patt-Pr√ºfung
            return false;
        }

        // ==================== START ====================
        window.onload = initGame;
        
        // Globale Funktionen f√ºr HTML onclick
        window.joinLobby = joinLobby;
        window.rematch = rematch;
        window.newGame = newGame;
        window.copyInviteLink = copyInviteLink;
    </script>
</body>
</html>
